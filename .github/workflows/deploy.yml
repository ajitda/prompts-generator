name: Deploy Laravel + React 

on:
  push:
    branches: [main]

jobs:
  Deploy:
    name: Test & Deploy (PHPUnit)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: mbstring, intl, gd, sqlite3, pdo_sqlite, fileinfo
          coverage: none

      - name: Setup Node.js 18
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm' 

      - name: Install composer dependencies
        run: composer install --no-ansi --no-interaction --no-scripts --no-progress --prefer-dist --ignore-platform-reqs

      - name: Copy .env
        run: cp .env.example .env

      - name: Generate app key
        run: php artisan key:generate

      - name: Prepare test database (SQLite)
        run: |
          mkdir -p database
          touch database/database.sqlite
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

      - name: Run migrations (SQLite)
        run: php artisan migrate --force
        env:
          DB_CONNECTION: sqlite
          DB_DATABASE: database/database.sqlite

      # Now install JS and Build
      - name: ðŸ“¦ Install & Build (Frontend SSR)
        run: |
          npm install
          npm run build:ssr

      # Run Backend Commands on Your Server (Prepares the server)
      - name: Run Backend Commands (Git, Composer, Migrations)
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            cd /var/www/idea-shareideas
            git reset --hard "origin/main" # Clears the public/js and public/css directories
            composer update --no-dev --optimize-autoloader --no-interaction --prefer-dist --ignore-platform-reqs
            php artisan down || true
            php artisan migrate 
            php artisan config:cache
            php artisan route:cache
            php artisan view:cache

      # Deploy Built Assets to Your Server
      - name: Deploy to Server
        uses: easingthemes/ssh-deploy@v5.1.0
        with:
          SSH_PRIVATE_KEY: ${{ secrets.DEPLOY_KEY }}
          REMOTE_HOST: ${{ secrets.DEPLOY_HOST }}
          REMOTE_USER: ${{ secrets.DEPLOY_USER }}
          TARGET: "/var/www/idea-shareideas/"
          SOURCE: "./public/build, ./bootstrap/ssr"
          REMOTE_PORT: ${{ secrets.DEPLOY_PORT || 22 }}

      # Bring App Up
      - name: Bring App Up
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.DEPLOY_HOST }}
          username: ${{ secrets.DEPLOY_USER }}
          key: ${{ secrets.DEPLOY_KEY }}
          port: ${{ secrets.DEPLOY_PORT || 22 }}
          script: |
            php /var/www/idea-shareideas/artisan up || true
            pm2 startOrRestart ecosystem.config.cjs